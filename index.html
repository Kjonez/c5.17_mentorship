<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Firebase Intro Prototype</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
</head>
<body>
    <div class="container">
        <h1>DanSuMentors <small>Now with Firebase</small></h1>
        <div class="col-sm-9">
            <table class="table sgt">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Course</th>
                        <th>Grade</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="col-sm-3">
            <form class="sgt-form">
                <div class="form-group">
                    <input type="text" class="form-control" id="name" placeholder="Name">
                </div>
                <div class="form-group">
                    <input type="number" class="form-control" id="age" placeholder="Age">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="location" placeholder="City, State">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="style" placeholder="Dance Style">
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="aboutme" placeholder="About Me"></textarea>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="experience" placeholder="experience"></textarea>
                </div>
                <button type="button" id="add-student" class="btn btn-success">Add Student</button>
                <button type="button" id="clear-form" class="btn btn-danger">Cancel</button>
            </form>
        </div>
    </div>
</body>
<script src="https://www.gstatic.com/firebasejs/4.1.5/firebase.js"></script>
</html>
<script>
$(document).ready(function(){
    $('.sgt-form').on('click', '.btn-success', function(){
        var fdata = getFormData();
        addStudent(fdata.name, fdata.age, fdata.location, fdata.style, fdata.aboutme, fdata.experience);
        clearForm();
    }).on('click', '.btn-info', function(){
        updateStudent($(this).attr('data-uid'));
        $(this).removeClass('btn-info').addClass('btn-success').attr('data-uid', null).text('Add Student');
        clearForm();
    }).on('click', '#clear-form', function(){
        $('#add-student').removeClass('btn-info').addClass('btn-success').attr('data-uid', null).text('Add Student');
        clearForm();
    });

    $('.sgt').on('click', '.delete', function(){
        var studentKey = $(this).closest('td').attr('data-uid');
        deleteStudent(studentKey, $(this));
    }).on('click', '.edit', function(){
        var studentKey = $(this).closest('td').attr('data-uid');
        $('#add-student').removeClass('btn-success').addClass('btn-info').attr('data-uid', studentKey).text('Update Student');
        var fdata = getRowData($(this).closest('tr'));
        populateFormData(fdata.sid, fdata.sname, fdata.course, fdata.grade);
    });
});

// Add config data

// var config = {
//   apiKey: "AIzaSyCHFg1Bdt-jJ5djrE1MRYkCGmtNVQKVN70",
//   authDomain: "student-grade-table-a3249.firebaseapp.com",
//   databaseURL: "https://student-grade-table-a3249.firebaseio.com",
//   projectId: "student-grade-table-a3249",
//   storageBucket: "",
//   messagingSenderId: "811153890299"
// };

var config = {
  apiKey: "AIzaSyA2Ybrw7spKPlA_ifaDoiRFB_zNNX6aw0M",
  authDomain: "dansumentors.firebaseapp.com",
  databaseURL: "https://dansumentors.firebaseio.com",
  projectId: "dansumentors",
  storageBucket: "dansumentors.appspot.com",
  messagingSenderId: "264293617297"
};

// Init firebase

firebase.initializeApp(config);

// Create firebase ref

const fbRef = firebase.database();

// Create event listener for the students node in your database

fbRef.ref('students').on('value', function(snapshot) {
  console.log('snapshot value:', snapshot.val());
  // var data = snapshot.val();
  // updateDom(data);
})

// Complete the addStudent function
function addStudent(name, age, location, style, about, experience){
    const student = {
        name,
        age,
        location,
        style,
        aboutme: about,
        experience
    };
    fbRef.ref('students').push(student);
}

// complete the delete function
function deleteStudent(key, ele){
    $(ele).remove();
    fbRef.ref(`students/${key}`).remove();
}

// complete the update function
function updateStudent(id){
   deleteStudent(id);
   var fdata = getFormData();
   addStudent(fdata.name, fdata.age, fdata.location, fdata.style, fdata.aboutme, fdata.experience);
}

// function updateDom(d){
//     var table = $('.sgt tbody');
//     table.html('');
//     for(var key in d){
//         if(d.hasOwnProperty(key)){
//             var row = $('<tr>');
//             var id = $('<td class="sid">' + d[key].name + '</td>');
//             var name = $('<td class="sname">' + d[key].student_name + '</td>');
//             var course = $('<td class="course">' + d[key].course + '</td>');
//             var grade = $('<td class="grade">' + d[key].grade + '</td>');
//             var actions = $('<td>', {'data-uid': key});
//             var edit = $('<button>', {
//                 class: 'btn btn-sm btn-info edit',
//                 text: 'Edit'
//             });
//             var del = $('<button>', {
//                 class: 'btn btn-sm btn-danger delete',
//                 text: 'Delete'
//             });

//             table.append(row.append(id, name, course, grade, actions.append(edit, del)));
//         }
//     }
// }

function clearForm(){
    $('.sgt-form input').each(function(k, v){
        $(v).val('');
    });
    $('textarea').each(function(k, v){
        $(v).val('');
    });
}

function getFormData(){
    var output = {};
    $('.sgt-form input').each(function(k, v){
        var ele = $(v);
        output[ele.attr('id')] = ele.val();
    });
    $('textarea').each(function(k, v){
        var ele = $(v);
        output[ele.attr('id')] = ele.val();
    })

    return output;
}

function populateFormData(sid, sname, course, grade){
    $('#sid').val(sid);
    $('#sname').val(sname);
    $('#course').val(course);
    $('#grade').val(grade);
}

function getRowData(e) {
    return {
        sid: e.find('.sid').text(),
        sname: e.find('.sname').text(),
        course: e.find('.course').text(),
        grade: e.find('.grade').text()
    };
}
</script>